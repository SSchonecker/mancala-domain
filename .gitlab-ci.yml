#include:
#  - template: Code-Quality.gitlab-ci.yml

stages:
  - compile
  - test
  #- checkCQ
  - dockermake
  - dockerrun
  
first_build:
  stage: compile
  script:
    - mvn clean compile

maven_test:
  stage: test
  script:
    - mvn clean verify
    - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered Total"; print 100*covered/instructions, "% covered" }' target/site/jacoco/jacoco.csv
    #- $missed=0
    #- $covered=0
    #- Get-Content .\target\site\jacoco\jacoco.csv | select-object -skip 1 | %{ [int]$missed+=$_.Split(',')[3]; [int]$covered+=$_.Split(',')[4]; } ; Write-Host "$covered / $($missed+$covered) instructions covered. Total $(100*$covered/$($missed+$covered))% covered"
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths: 
      - target/surefire-reports/TEST-nl.sogyo.mancala.domain.PitTest.xml
      - target/site/jacoco/jacoco.xml

#code_quality:
#  stage: checkCQ

build_image:
  stage: dockermake
  tags:
    - docker
  before_script:
    - docker info
    - docker login -u $DOCKER_USER_NAME -p $DOCKER_ACCESS_TOKEN
  script:
    - docker build -t docker4sschonecker/sschonecker-repo:mancalaimage .
    - docker push docker4sschonecker/sschonecker-repo:mancalaimage
  after_script:
    - docker logout docker4sschonecker/sschonecker-repo
    
test_image:
  stage: dockerrun
  tags:
    - docker
  before_script:
    - docker info
    - docker login -u $DOCKER_USER_NAME -p $DOCKER_ACCESS_TOKEN
  script:
    - docker pull docker4sschonecker/sschonecker-repo:mancalaimage
    - docker run --name silkes-container docker4sschonecker/sschonecker-repo:mancalaimage
    - docker ps -all
    - docker rm -f silkes-container
    - docker ps -all
  after_script:
    - docker logout docker4sschonecker/sschonecker-repo
